version: 2.1

# Définir un nouvel exécuteur Docker
executors:
  docker-publisher:
    machine:
      image: ubuntu-2204:2024.01.1
    environment:
      IMAGE_NAME: pierreeuh/www-nodejs:nodejs

jobs:
  build:
    executor: docker-publisher
    steps:
      - checkout

      - run:
          name: Build Docker Image
          command: |
            docker build -t $IMAGE_NAME .

      - run:
          name: Install curl
          command: |
             sudo apt-get update && sudo apt-get install -y curl

      - run:
          name: Run Docker Container
          command: |
            docker run -d --name test-www-nodejs -p 8080:8080 $IMAGE_NAME

      - run:
          name: Test Web Server with Curl
          command: |
            curl http://localhost:8080

      - run:
          name: Login to Docker Hub
          command: |
            echo "$DOCKERHUB_PASS" | docker login --username $DOCKERHUB_USERNAME --password-stdin
          when: on_success

      - run:
          name: Push Image to Docker Hub
          command: |
            docker push $IMAGE_NAME
          when: on_success

workflows:
  version: 2
  build_and_push:
    jobs:
      - build
